version: '3.8'

services:
  # Solana Local Validator
  solana-validator:
    image: solanalabs/solana:v1.18.4
    container_name: solana-validator
    ports:
      - "8899:8899" # RPC port
      - "8900:8900" # WebSocket port
      - "9900:9900" # Metrics port
    volumes:
      - solana-data:/home/solana/.local/share/solana
      - ./contracts/solana/config:/home/solana/.config/solana
    command: >
      sh -c "
        solana-test-validator 
        --reset 
        --quiet 
        --rpc-port 8899 
        --rpc-bind-address 0.0.0.0 
        --rpc-pubsub-enable-block-subscription 
        --rpc-pubsub-enable-vote-subscription 
        --enable-rpc-transaction-history 
        --limit-ledger-size 50000000
      "
    environment:
      - RUST_LOG=warn
    networks:
      - solana-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8899/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Solana CLI tools (for deployment and management)
  solana-cli:
    image: solanalabs/solana:v1.18.4
    container_name: solana-cli
    volumes:
      - ./contracts/solana/config:/home/solana/.config/solana
      - ./contracts/solana:/workspace/contracts
    working_dir: /workspace
    command: >
      sh -c "
        # Install Rust and Anchor CLI
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y &&
        source ~/.cargo/env &&
        cargo install --git https://github.com/coral-xyz/anchor avm --locked --force &&
        avm install latest &&
        avm use latest &&
        tail -f /dev/null
      "
    depends_on:
      - solana-validator
    networks:
      - solana-network

  # Anchor CLI for building contracts
  anchor-cli:
    image: rust:1.75
    container_name: anchor-cli
    volumes:
      - ./contracts/solana:/workspace/contracts
    working_dir: /workspace
    command: >
      sh -c "
        # Install Rust and Anchor CLI
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y &&
        source ~/.cargo/env &&
        cargo install --git https://github.com/coral-xyz/anchor avm --locked --force &&
        avm install latest &&
        avm use latest &&
        tail -f /dev/null
      "
    networks:
      - solana-network

volumes:
  solana-data:
    driver: local

networks:
  solana-network:
    driver: bridge
